<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>theblack 텍스트 입력</title>
  <script src="https://unpkg.com/html-to-image@1.11.11/dist/html-to-image.min.js"></script>
  <!-- Supabase JS CDN 추가 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    /* (중략, 네가 준 스타일 그대로) */
    iframe { display: none; } /* 숨김 */
  </style>
</head>
<body>
  <div class="container">
    <h2>📝 실시간 가격표 텍스트 입력</h2>
    <form id="theblackForm">
      <textarea id="mainText" name="mainText"></textarea>
      <button id="submitBtn" type="submit">✅ 텍스트 적용하기</button>
    </form>
    <div id="message"></div>
    <div id="resultBox" style="display:none;">
      <h3>👇 아래 코드를 그대로 복붙하시면 됩니다</h3>
      <textarea id="resultCode" readonly></textarea>
    </div>
    <iframe id="hiddenFrame" src="" width="1" height="1"></iframe>
  </div>
  <script>
    // Supabase 정보 (네 프로젝트에 맞게 입력)
    const supabaseUrl = "https://ssnmitgehgzzcpmqwhzt.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzbm1pdGdlaGd6emNwbXF3aHp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNjI1MDgsImV4cCI6MjA2ODkzODUwOH0.u3FrSDh5qYeccQmn0PkOs4nfqIhXLSFHhpWj2JXhTrA";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    document.getElementById("theblackForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const submitBtn = document.getElementById("submitBtn");
      const messageDiv = document.getElementById("message");
      const resultBox = document.getElementById("resultBox");
      const mainText = document.getElementById("mainText").value;
      const params = new URLSearchParams({ mainText });

      // 1. iframe에 디자인 페이지 띄우기
      const iframe = document.getElementById("hiddenFrame");
      iframe.src = `/changong/theblackempty.html?${params.toString()}`;

      // 2. 안내문 띄우기
      submitBtn.disabled = true;
      messageDiv.innerText = "이미지를 생성하고 있습니다. 잠시만 기다려주세요...";

      // 3. iframe 로드 후 캡쳐 진행 (2초 대기)
      iframe.onload = async function() {
        setTimeout(async () => {
          try {
            // iframe 내 .render-target 선택
            const node = iframe.contentWindow.document.querySelector('.render-target');
            // 캡쳐
            const dataUrl = await window.htmlToImage.toPng(node);

            // 4. Supabase Storage에 업로드
            // 고유 파일명 만들기 (타임스탬프 등)
            const fileName = `theblack_${Date.now()}.png`;
            const fileData = await (await fetch(dataUrl)).blob();
            const { data, error } = await supabase
              .storage
              .from('changong-images')
              .upload(fileName, fileData, { cacheControl: '3600', upsert: false });

            if (error) {
              messageDiv.innerText = "이미지 업로드 실패: " + error.message;
              submitBtn.disabled = false;
              return;
            }

            // 5. Public URL 생성
            const publicUrl = `${supabaseUrl}/storage/v1/object/public/changong-images/${fileName}`;

            // 6. 결과 HTML 생성 및 표시
            const finalHTML = `<a href="https://open.kakao.com/o/gUVp9cwh" target="_blank">
  <img src="${publicUrl}" alt="가격표" style="width:100%; max-width:720px;">
</a>`;
            document.getElementById("resultCode").value = finalHTML;
            resultBox.style.display = "block";
            messageDiv.innerText = "✅ 이미지 생성이 완료되었습니다!";
            submitBtn.disabled = false;
          } catch (err) {
            messageDiv.innerText = "캡쳐/업로드 오류: " + err.message;
            submitBtn.disabled = false;
          }
        }, 2000);
      };
    });
  </script>
</body>
</html>
