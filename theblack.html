<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>theblack í…ìŠ¤íŠ¸ ì…ë ¥</title>
  <script src="https://unpkg.com/html-to-image@1.11.11/dist/html-to-image.min.js"></script>
  <!-- Supabase JS CDN ì¶”ê°€ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    /* (ì¤‘ëµ, ë„¤ê°€ ì¤€ ìŠ¤íƒ€ì¼ ê·¸ëŒ€ë¡œ) */
    iframe { display: none; } /* ìˆ¨ê¹€ */
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ“ ì‹¤ì‹œê°„ ê°€ê²©í‘œ í…ìŠ¤íŠ¸ ì…ë ¥</h2>
    <form id="theblackForm">
      <textarea id="mainText" name="mainText"></textarea>
      <button id="submitBtn" type="submit">âœ… í…ìŠ¤íŠ¸ ì ìš©í•˜ê¸°</button>
    </form>
    <div id="message"></div>
    <div id="resultBox" style="display:none;">
      <h3>ğŸ‘‡ ì•„ë˜ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ë³µë¶™í•˜ì‹œë©´ ë©ë‹ˆë‹¤</h3>
      <textarea id="resultCode" readonly></textarea>
    </div>
    <iframe id="hiddenFrame" src="" width="1" height="1"></iframe>
  </div>
  <script>
    // Supabase ì •ë³´ (ë„¤ í”„ë¡œì íŠ¸ì— ë§ê²Œ ì…ë ¥)
    const supabaseUrl = "https://ssnmitgehgzzcpmqwhzt.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzbm1pdGdlaGd6emNwbXF3aHp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNjI1MDgsImV4cCI6MjA2ODkzODUwOH0.u3FrSDh5qYeccQmn0PkOs4nfqIhXLSFHhpWj2JXhTrA";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    document.getElementById("theblackForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const submitBtn = document.getElementById("submitBtn");
      const messageDiv = document.getElementById("message");
      const resultBox = document.getElementById("resultBox");
      const mainText = document.getElementById("mainText").value;
      const params = new URLSearchParams({ mainText });

      // 1. iframeì— ë””ìì¸ í˜ì´ì§€ ë„ìš°ê¸°
      const iframe = document.getElementById("hiddenFrame");
      iframe.src = `/changong/theblackempty.html?${params.toString()}`;

      // 2. ì•ˆë‚´ë¬¸ ë„ìš°ê¸°
      submitBtn.disabled = true;
      messageDiv.innerText = "ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...";

      // 3. iframe ë¡œë“œ í›„ ìº¡ì³ ì§„í–‰ (2ì´ˆ ëŒ€ê¸°)
      iframe.onload = async function() {
        setTimeout(async () => {
          try {
            // iframe ë‚´ .render-target ì„ íƒ
            const node = iframe.contentWindow.document.querySelector('.render-target');
            // ìº¡ì³
            const dataUrl = await window.htmlToImage.toPng(node);

            // 4. Supabase Storageì— ì—…ë¡œë“œ
            // ê³ ìœ  íŒŒì¼ëª… ë§Œë“¤ê¸° (íƒ€ì„ìŠ¤íƒ¬í”„ ë“±)
            const fileName = `theblack_${Date.now()}.png`;
            const fileData = await (await fetch(dataUrl)).blob();
            const { data, error } = await supabase
              .storage
              .from('changong-images')
              .upload(fileName, fileData, { cacheControl: '3600', upsert: false });

            if (error) {
              messageDiv.innerText = "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: " + error.message;
              submitBtn.disabled = false;
              return;
            }

            // 5. Public URL ìƒì„±
            const publicUrl = `${supabaseUrl}/storage/v1/object/public/changong-images/${fileName}`;

            // 6. ê²°ê³¼ HTML ìƒì„± ë° í‘œì‹œ
            const finalHTML = `<a href="https://open.kakao.com/o/gUVp9cwh" target="_blank">
  <img src="${publicUrl}" alt="ê°€ê²©í‘œ" style="width:100%; max-width:720px;">
</a>`;
            document.getElementById("resultCode").value = finalHTML;
            resultBox.style.display = "block";
            messageDiv.innerText = "âœ… ì´ë¯¸ì§€ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!";
            submitBtn.disabled = false;
          } catch (err) {
            messageDiv.innerText = "ìº¡ì³/ì—…ë¡œë“œ ì˜¤ë¥˜: " + err.message;
            submitBtn.disabled = false;
          }
        }, 2000);
      };
    });
  </script>
</body>
</html>
